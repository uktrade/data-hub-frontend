{% extends "./_layouts/view.njk" %}

{% set contactName %}
  <a href="/contacts/{{ values.contact.id }}">{{ values.contact.name }}</a>
{% endset %}

{% set contactEmail %}
  {% set emails = [
    values.contact_email,
    values.contact.email,
    values.contact.email_alternative
  ] %}

  {% for email in emails | removeNilAndEmpty %}
    <a href="mailto:{{ email }}">{{ email }}</a>
    <br>
  {% endfor %}
{% endset %}

{% set contactPhone %}
  {% set phones = [
    values.contact.telephone_number,
    values.contact.telephone_alternative
  ] %}

  {% if values.contact_phone %}
    {{ values.contact_phone }}
    <br>
  {% endif %}

  {% for phone in phones | removeNilAndEmpty %}
    ({{ values.contact.telephone_countrycode }}) {{ phone }}
    <br>
  {% endfor %}
{% endset %}

{% block body_main_content %}
  {% if order.status === 'quote_awaiting_acceptance' %}
    {% call Message({ type: 'info', element: 'div' }) %}
      <p>You cannot edit the order whilst a quote is awaiting acceptance.</p>
      <p>You must <a href="quote">cancel the quote</a> to edit the order.</p>
    {% endcall %}
  {% endif %}

  {% if order.status === 'cancelled' %}
    {% call Message({ type: 'info', element: 'div' }) %}
      <p>Order cancelled on {{ order.cancelled_on | formatDateTime }} by {{ order.cancelled_by.name }}.</p>
      <p>It was cancelled because {{ order.cancellation_reason.name | lower }}.</p>
    {% endcall %}
  {% endif %}

  {{ AnswersSummary({
    heading: 'Client contact details',
    actions: [{
      url: 'edit/client-details' if order.isEditable
    }],
    items: [{
      label: 'Name',
      value: contactName
    }, {
      label: 'Phone',
      value: contactPhone
    }, {
      label: 'Email',
      value: contactEmail
    }]
  }) }}

  {% call AnswersSummary({
    heading: 'Advisers in the market',
    actions: [{
      url: 'edit/assignees' if order.isEditable,
      label: 'Add or remove'
    }, {
      url: 'edit/assignee-time' if order.isEditable,
      label: 'Estimate hours'
    }]
  }) %}
    <tbody>
      {% for assignee in values.assignees %}
        <tr>
          <th class="c-answers-summary__title" scope="row">
            {{ assignee.adviser.name }} {{ '(you)' if assignee.adviser.id === user.id }}
            {% if assignee.is_lead %}
              <span class="c-badge">Lead adviser</span>
            {% endif %}
          </th>
          <td class="c-answers-summary__content c-answers-summary__control">
            {% if not assignee.is_lead %}
              {% call Form ({
                action: 'edit/lead-assignee',
                hideFormActions: true,
                hiddenFields: {
                  adviserId: assignee.adviser.id,
                  orderId: order.id
                }
              }) %}
                <button type="submit" class="button button--link button--compact">Set as lead adviser</button>
              {% endcall %}
            {% endif %}
          </td>
          <td class="c-answers-summary__content c-answers-summary__content--number">
            {{ assignee.estimated_time | humanizeDuration if assignee.estimated_time else 'No hours estimated' }}
          </td>
        </tr>
      {% else %}
        <tr>
          <td class="c-answers-summary__content c-answers-summary__content--muted" colspan="3">None added</td>
        </tr>
      {% endfor %}
    </tbody>

    <tfoot>
      <tr>
        <td class="c-answers-summary__footer" colspan="3">
          {% if not values.assignees.length or values.estimatedTimeSum < 1 %}
            <span class="c-answers-summary__footer-value">No time estimated</span>
          {% else %}
            <span class="c-answers-summary__footer-value">
              {{ values.estimatedTimeSum | humanizeDuration }}
            </span>
            estimated in total
          {% endif %}
        </td>
      </tr>
    </tfoot>
  {% endcall %}

  {{ AnswersSummary({
    heading: 'Advisers in the UK',
    actions: [{
      url: 'edit/subscribers' if order.isEditable,
      label: 'Add or remove'
    }],
    items: values.subscribers | map('name') if values.subscribers.length,
    fallbackText: 'None added'
  }) }}

  {{ AnswersSummary({
    heading: 'Information for the quote',
    actions: [{
      url: 'edit/quote-details' if order.isEditable
    }],
    items: [{
      label: 'Delivery date',
      value: values.delivery_date | formatDate if values.delivery_date,
      fallbackText: 'Not set'
    }, {
      label: 'Description of the activity',
      value: values.description,
      fallbackText: 'Not added'
    }]
  }) }}

  {{ AnswersSummary({
    heading: 'Internal use only',
    actions: [{
      url: 'edit/internal-details' if order.isEditable
    }],
    items: [{
      label: 'Service type' | pluralise(values.service_types.length),
      value: values.service_types | map('name') | join(', ') if values.service_types.length,
      fallbackText: 'None selected'
    }, {
      label: 'Sector',
      value: values.sector.name,
      fallbackText: 'Not selected'
    }, {
      label: 'Further information',
      value: values.further_info
    }, {
      label: 'Existing representatives',
      value: values.existing_agents
    }, {
      label: 'Contacts not to approach',
      value: values.contacts_not_to_approach,
      fallbackText: 'None added'
    }, {
      label: 'Permission to approach contacts',
      value: values.permission_to_approach_contacts
    }, {
      label: 'Product information',
      value: values.product_info
    }]
  }) }}

  {% if values.vat_verified === true %}
    {% set verifiedState = translate('fields.vat_verified.options.valid') %}
  {% elif values.vat_verified === false %}
    {% set verifiedState = translate('fields.vat_verified.options.invalid') %}
  {% else %}
    {% set verifiedState = translate('fields.vat_verified.options.unverified') %}
  {% endif %}

  {% set billingContact = [
    values.billing_contact_name,
    values.billing_email,
    values.billing_phone
  ] | removeNilAndEmpty | join('<br>') %}

  {% set billingAddress = [
    values.billing_address_1,
    values.billing_address_2,
    values.billing_address_town,
    values.billing_address_county,
    values.billing_address_postcode,
    values.billing_address_country.name
  ] | removeNilAndEmpty %}

  {% set registeredAddress = [
    company.registered_address_1,
    company.registered_address_2,
    company.registered_address_town,
    company.registered_address_county,
    company.registered_address_postcode,
    company.registered_address_country.name
  ] | removeNilAndEmpty %}

  {% set tradingAddress = [
    company.trading_address_1,
    company.trading_address_2,
    company.trading_address_town,
    company.trading_address_county,
    company.trading_address_postcode,
    company.trading_address_country.name
  ] | removeNilAndEmpty %}

  {% set companyAddress = tradingAddress if tradingAddress|length else registeredAddress %}

  {% set costText %}
    {{ values.total_cost | formatCurrency }}

    {% if values.vat_cost > 0 %}
      ({{ values.subtotal_cost | formatCurrency }} excluding VAT)
    {% else %}
      (No VAT applies)
    {% endif %}

    {% if values.discount_value %}
    (includes a net discount of {{ values.discount_value | formatCurrency }})
    {% endif %}
  {% endset %}

  {{ AnswersSummary({
    heading: 'Invoice details',
    actions: [{
      url: 'edit/payment' if order.isEditable
    }],
    items: [{
      label: 'Price',
      value: costText if values.total_cost,
      fallbackText: 'Estimated hours and VAT category must be set to calculate price'
    }, {
      label: 'Billing contact',
      value: billingContact
    }, {
      label: 'Billing address',
      value: billingAddress | join(', ') if billingAddress|length else companyAddress | join(', '),
      fallbackText: 'Not added'
    }, {
      label: 'VAT category',
      value: translate('fields.vat_status.options.' + values.vat_status) if values.vat_status,
      fallbackText: 'Not set'
    }, {
      label: 'VAT number',
      value: values.vat_number + ' (' + verifiedState + ')' if values.vat_number
    }, {
      label: 'Purchase Order (PO) number',
      value: values.po_number,
      fallbackText: 'Not added'
    }]
  }) }}

  {% if not billingAddress | length %}
    {% call Message({ type: 'muted' }) %}
      The company's {{ 'trading' if tradingAddress|length else 'registered' }} address is currently being used for the invoice.
    {% endcall %}
  {% endif %}

{% endblock %}
